#!/bin/bash
# Consolidated theme manager for alacritty and neovim

# Directories and files
alacritty_themes_dir="$HOME/.config/alacritty/themes"
alacritty_theme_file="$HOME/.config/alacritty/theme.toml"
nvim_config_dir="$HOME/.config/nvim/lua/config"
nvim_theme_file="$nvim_config_dir/theme.lua"

# ============================================================================
# Alacritty functions
# ============================================================================

alacritty_list() {
    ls -1 "$alacritty_themes_dir" | sed 's/\.toml$//'
}

alacritty_apply() {
    local theme="$1"
    local theme_path="$alacritty_themes_dir/$theme.toml"
    
    if [[ ! -f "$theme_path" ]]; then
        echo "Alacritty theme not found: $theme" >&2
        return 1
    fi
    
    cp "$theme_path" "$alacritty_theme_file"
}

# ============================================================================
# Neovim functions
# ============================================================================

nvim_find_socket() {
    for sock in /tmp/nvim-*; do
        [[ -S "$sock" ]] && echo "$sock" && return 0
    done
    return 1
}

nvim_list() {
    local sock
    if sock=$(nvim_find_socket); then
        nvim --headless --server "$sock" --remote-expr 'join(getcompletion("", "color"), "\n")' 2>/dev/null | tr -d '\r'
    else
        nvim --headless -c 'for c in getcompletion("", "color") | echo c | endfor' -c 'qa' 2>&1 | tr -d '\r'
    fi
}

nvim_apply() {
    local theme="$1"

    # Update all running nvim instances
    for sock in /tmp/nvim-*; do
        [[ -S "$sock" ]] && nvim --server "$sock" --remote-send "<Esc>:colorscheme $theme<CR>" 2>/dev/null
    done

    # Write theme file for new instances
    cat > "$nvim_theme_file" <<EOF
-- Auto-generated by theme manager. Do not edit.
vim.cmd.colorscheme("$theme")
EOF
}

# ============================================================================
# Unified functions
# ============================================================================

unified_list() {
    local nvim_themes alacritty_themes
    nvim_themes=$(nvim_list | sort)
    alacritty_themes=$(alacritty_list | sort)
    comm -12 <(echo "$nvim_themes") <(echo "$alacritty_themes")
}

unified_apply() {
    local theme="$1"
    alacritty_apply "$theme" && echo "Applied to alacritty: $theme"
    nvim_apply "$theme" && echo "Applied to neovim: $theme"
}

# ============================================================================
# CLI
# ============================================================================

usage() {
    cat <<EOF
Usage: theme [COMMAND] [OPTIONS] [THEME]

Commands:
  alacritty [OPTIONS] [THEME]    Manage alacritty theme
  nvim [OPTIONS] [THEME]         Manage neovim theme
  (no command)                   Interactive picker for both tools

Options:
  -i, --interactive             Select theme with fzf
  -h, --help                    Show this help

Examples:
  theme                         # Interactive picker
  theme catppuccin-mocha        # Apply to both
  theme alacritty               # List alacritty themes
  theme alacritty catppuccin-mocha  # Apply to alacritty only
  theme nvim -i                 # Interactive picker for neovim
EOF
}

main() {
    local cmd="$1"
    
    case "$cmd" in
        -h|--help|help)
            usage
            exit 0
            ;;
        alacritty)
            shift
            alacritty_cmd "$@"
            ;;
        nvim)
            shift
            nvim_cmd "$@"
            ;;
        "")
            # No command - interactive unified picker
            local theme
            theme=$(unified_list | fzf --prompt="Select theme: ") || exit 0
            unified_apply "$theme"
            ;;
        -i|--interactive)
            # Also support -i as shorthand for interactive
            local theme
            theme=$(unified_list | fzf --prompt="Select theme: ") || exit 0
            unified_apply "$theme"
            ;;
        *)
            # Assume it's a theme name
            unified_apply "$cmd"
            ;;
    esac
}

alacritty_cmd() {
    local interactive=false
    local theme=""
    
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -h|--help)
                echo "Usage: theme alacritty [OPTIONS] [THEME]"
                echo "Options:"
                echo "  -i, --interactive    Select theme with fzf"
                exit 0
                ;;
            -i|--interactive)
                interactive=true
                shift
                ;;
            -*)
                echo "Unknown option: $1" >&2
                exit 1
                ;;
            *)
                theme="$1"
                shift
                ;;
        esac
    done
    
    if [[ -z "$theme" && "$interactive" == false ]]; then
        echo "Available alacritty themes:"
        alacritty_list
        exit 0
    fi
    
    if [[ "$interactive" == true ]]; then
        theme=$(alacritty_list | fzf --prompt="Select theme: ") || exit 0
    fi
    
    if [[ -n "$theme" ]]; then
        alacritty_apply "$theme" && echo "Applied to alacritty: $theme"
    fi
}

nvim_cmd() {
    local interactive=false
    local theme=""
    
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -h|--help)
                echo "Usage: theme nvim [OPTIONS] [THEME]"
                echo "Options:"
                echo "  -i, --interactive    Select theme with fzf"
                exit 0
                ;;
            -i|--interactive)
                interactive=true
                shift
                ;;
            -*)
                echo "Unknown option: $1" >&2
                exit 1
                ;;
            *)
                theme="$1"
                shift
                ;;
        esac
    done
    
    if [[ -z "$theme" && "$interactive" == false ]]; then
        echo "Available neovim themes:"
        nvim_list
        exit 0
    fi
    
    if [[ "$interactive" == true ]]; then
        theme=$(nvim_list | fzf --prompt="Select theme: ") || exit 0
    fi
    
    if [[ -n "$theme" ]]; then
        nvim_apply "$theme" && echo "Applied to neovim: $theme"
    fi
}

main "$@"
